<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Implementation of nested set design of SQL with Java - Nested Set Modified Preorder Tree Traversal - Bobo&#039;s site</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Bobo&#039;s site"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Bobo&#039;s site"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="简体中文 PreviousRecently, we got a requirement for storage directories and files，the condition is,  Input parameter is the path of the root directory which was unpacked.  The files will not change nor"><meta property="og:type" content="blog"><meta property="og:title" content="Implementation of nested set design of SQL with Java - Nested Set Modified Preorder Tree Traversal"><meta property="og:url" content="https://bobotheknight.github.io/2022/03/28/nested-set-modified-preorder-tree-traversal-realizing-sql-nested-set-design-in-java/"><meta property="og:site_name" content="Bobo&#039;s site"><meta property="og:description" content="简体中文 PreviousRecently, we got a requirement for storage directories and files，the condition is,  Input parameter is the path of the root directory which was unpacked.  The files will not change nor"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://bobotheknight.github.io/resources/nested_set/nested_set_model.png"><meta property="og:image" content="https://bobotheknight.github.io/resources/nested_set/nested_set_1_number.png"><meta property="article:published_time" content="2022-03-28T05:10:10.000Z"><meta property="article:modified_time" content="2023-07-12T17:58:08.064Z"><meta property="article:author" content="BoboTheKnight"><meta property="article:tag" content="SQL, Tree traversal, Project Experience, Java, System Design"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://bobotheknight.github.io/resources/nested_set/nested_set_model.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://bobotheknight.github.io/2022/03/28/nested-set-modified-preorder-tree-traversal-realizing-sql-nested-set-design-in-java/"},"headline":"Implementation of nested set design of SQL with Java - Nested Set Modified Preorder Tree Traversal","image":["https://bobotheknight.github.io/resources/nested_set/nested_set_model.png","https://bobotheknight.github.io/resources/nested_set/nested_set_1_number.png"],"datePublished":"2022-03-28T05:10:10.000Z","dateModified":"2023-07-12T17:58:08.064Z","author":{"@type":"Person","name":"BoboTheKnight"},"publisher":{"@type":"Organization","name":"Bobo's site","logo":{"@type":"ImageObject","url":"https://bobotheknight.github.io/img/logo.png"}},"description":"简体中文 PreviousRecently, we got a requirement for storage directories and files，the condition is,  Input parameter is the path of the root directory which was unpacked.  The files will not change nor"}</script><link rel="canonical" href="https://bobotheknight.github.io/2022/03/28/nested-set-modified-preorder-tree-traversal-realizing-sql-nested-set-design-in-java/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Bobo&#039;s site" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" href="https://bobotheknight.github.io/zh-CN"> 简体中文</a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-03-28T05:10:10.000Z" title="3/28/2022, 1:10:10 a.m.">2022-03-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-07-12T17:58:08.064Z" title="7/12/2023, 1:58:08 p.m.">2023-07-12</time></span><span class="level-item"><a class="link-muted" href="/categories/Technology/">Technology</a></span><span class="level-item">10 minutes read (About 1489 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Implementation of nested set design of SQL with Java - Nested Set Modified Preorder Tree Traversal</h1><div class="content"><p><a href="https://bobotheknight.github.io/zh-CN/2022/03/28/2022-03-28-implement-SQL-nested-sets-in-Java-zh/"><i class="fa-solid fa-language"></i>   简体中文</a></p>
<h2 id="Previous"><a href="#Previous" class="headerlink" title="Previous"></a>Previous</h2><p>Recently, we got a requirement for storage directories and files，the condition is,</p>
<ol>
<li>Input parameter is the path of the root directory which was unpacked. </li>
<li>The files will not change nor update after unpacked.</li>
</ol>
<p>The details of the requirement is,</p>
<ol>
<li>The directories and all its subdirectories and sub-files need to be parsed into a tree structure response to the front end.</li>
<li>When the user clicks on each level of directory, we need to get the files in this directory and all its subdirectories for some business data statistics.</li>
<li>We can only use the MySQL.(Can’t use a graph database.)</li>
</ol>
<span id="more"></span>
<p>After <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4048151/what-are-the-options-for-storing-hierarchical-data-in-a-relational-database">research</a>, the found that <a target="_blank" rel="noopener" href="http://mikehillyer.com/articles/managing-hierarchical-data-in-mysql/">nested set design</a> is well suited for such a scenario.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Note - If graph databases are used in the project, graph databases are a better choice for handling complex hierarchical data.</span><br></pre></td></tr></table></figure></p>
<p>It is hard to find ready-made code on the Internet that uses Java to implement this, and only found a <a target="_blank" rel="noopener" href="https://github.com/eXsio/nestedj">project</a> on github that implements part of the functionality. However, this project does not support MyBatis and I do not plan to adopt it, so I can only implement the nested set design by myself.</p>
<p>This article will briefly introduce the Nested Set Model Nested Set Model, details of how to use Java, from the table to the library to implement the nested set model.</p>
<p>The examples in this article use <code>MySQL 8.0</code>, <code>JDK 8</code>.</p>
<hr>
<h2 id="Nested-Set-Model"><a href="#Nested-Set-Model" class="headerlink" title="Nested Set Model"></a>Nested Set Model</h2><p>When faced with hierarchically structured data stores, such as catalogs, ! <a href="... /... /... /... /... /resources/nested_set/nested_set_tree_directory.png">catalog storage</a></p>
<p>We tend to use the scheme known as the <strong>neighboring table model</strong> with table field designs of approx:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id, name, parentId</span><br></pre></td></tr></table></figure><br>In the adjacency table, all data has a <code>parentId</code> field to store its parent node ID. if the current node is the root node, its parent node is <code>NULL</code> or <code>-1</code>. When traversing, you can use recursion to query the whole tree, but also easy to query the next level of nodes. It is also easy to add and delete. However, when the amount of data is large, querying the whole tree will affect performance, and even lead to memory overflow.<br>Therefore, in use, we usually use lazy loading to show the data one level at a time. Or limit the depth of the recursion to show only part of the data.</p>
<p>If the known data additions, deletions and changes are rare, the query performance requirements are relatively high, and like our needs, we need to check all the leaf nodes under a node, you can consider using the nested set model. The design of the nested set model is approximately:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id, name, left_index, right_index, depth</span><br></pre></td></tr></table></figure><br>In other words, this views the individual nodes as individual containers, with the child nodes inside the parent node and all nodes in the root node; represented in a picture as follows:<br><img src="../../../../../resources/nested_set/nested_set_model.png" alt="nested_set_model"></p>
<p>Then numbered from left to right, each container has a left and right two numbers, that is, for the <code>left</code> and <code>right</code>; represented by the picture as follows:<br><img src="../../../../../resources/nested_set/nested_set_1_number.png" alt="nested_set_1_number"></p>
<p>To make it easier to query the next level node and other nodes, a depth field can be added to indicate the depth.<br>At this point, the left and right values of each node can be obtained.<br>Below are just a few of the most commonly used SQLs. Other SQLs can be found in <a target="_blank" rel="noopener" href="http://mikehillyer.com/articles/managing-hierarchical-data-in-mysql/">Managing Hierarchical Data in MySQL</a>.</p>
<hr>
<h2 id="Implemented-in-Java"><a href="#Implemented-in-Java" class="headerlink" title="Implemented in Java"></a>Implemented in Java</h2><h3 id="MySQL-Table-Design"><a href="#MySQL-Table-Design" class="headerlink" title="MySQL Table Design"></a>MySQL Table Design</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `file_nested_sets_demo` (</span><br><span class="line">  `id` varchar(100) NOT NULL COMMENT &#x27;Document ID，unique identifier&#x27;,</span><br><span class="line">  `path` varchar(2000) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT &#x27;Full path of the file&#x27;,</span><br><span class="line">  `type` varchar(100) DEFAULT NULL COMMENT &#x27;Document type; Directory,File&#x27;,</span><br><span class="line">  `size` double DEFAULT NULL COMMENT &#x27;file size&#x27;,</span><br><span class="line">  `tree_id` bigint DEFAULT NULL,</span><br><span class="line">  `left_index` bigint NOT NULL,</span><br><span class="line">  `right_index` bigint NOT NULL,</span><br><span class="line">  `depth` bigint NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_tree_id_indexes` (`tree_id`,`left_index`,`right_index`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=&#x27;文件嵌套集表示例&#x27;;</span><br></pre></td></tr></table></figure>
<h3 id="Constructing-mapping-entities"><a href="#Constructing-mapping-entities" class="headerlink" title="Constructing mapping entities"></a>Constructing mapping entities</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  Nested set objects used by the deposit database</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileNestedSetsDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Document ID, unique identification</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Full path of the file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Document type; FILE/DIRECTORY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * file size</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long treeId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long leftIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long rightIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long depth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Data-number-entry"><a href="#Data-number-entry" class="headerlink" title="Data number entry"></a>Data number entry</h3><p>The input data is known to be a file path, and the path structure is the same as in the above figure, for example:<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|== means folder; |-- means file.</span><br><span class="line"></span><br><span class="line"> |==resources</span><br><span class="line">            |==data</span><br><span class="line">                  |--table_design</span><br><span class="line">            |==mapper</span><br><span class="line">                  |==server</span><br><span class="line">                        |--ServerMapper.xml</span><br><span class="line">                  |==source</span><br><span class="line">                  |--AMapper.xml</span><br><span class="line">            |--bootstrap.properties</span><br><span class="line">            |--logback-spring.xml</span><br></pre></td></tr></table></figure></p>
<p>The expected output is:<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">depth   left_index|||path|||right_index</span><br><span class="line">0   1|||\resources|||20</span><br><span class="line">1   2|||\resources\data||5</span><br><span class="line">2   3|||\resources\data\table_design|||4</span><br><span class="line">1   6|||\resources\mapper|||15</span><br><span class="line">2   7|||\resources\mapper\server|||10</span><br><span class="line">3   8|||\resources\mapper\server\ServerMapper.xml|||9</span><br><span class="line">2   11|||\resources\mapper\source|||12</span><br><span class="line">2   13|||\resources\mapper\AMapper.xml|||14</span><br><span class="line">1   16|||\resources\bootstrap.properties|||17</span><br><span class="line">1   18|||\resources\logback-spring.xml|||19</span><br></pre></td></tr></table></figure></p>
<p>We can construct the data using the <code>precedence traversal algorithm</code>, traversing its children and assigning values from left to right, one layer at a time.<br>The following code uses a depth-first approach to traverse the directory and assign values, returning Map.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NestedSetsUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *Use depth-first traversal of the catalog to return Map, which is used to support nested set initial entry.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root Directories to be traversed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Map&lt;File, NestedSetObj&gt;</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;File, NestedSetObj&gt; <span class="title function_">dfs2NestedSets</span><span class="params">(File root)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Record Depth -1 per stack out, +1 per stack in.</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">depth</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="comment">// left and right values</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        Deque&lt;File&gt; stack = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">        stack.push(root);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// A global collection of objects that also indicates whether this object has been on the stack.</span></span><br><span class="line">        Map&lt;File, NestedSetObj&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// root directory </span></span><br><span class="line">        <span class="type">NestedSetObj</span> <span class="variable">rootObj</span> <span class="operator">=</span> NestedSetObj.builder().path(root.getAbsolutePath()).depth(depth).left(index++).build();</span><br><span class="line">        map.put(root, rootObj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">cur</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">            depth--;</span><br><span class="line">            File[] files = cur.listFiles();</span><br><span class="line">            <span class="keyword">if</span> (files != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (File next : files) &#123;</span><br><span class="line">                    <span class="comment">// if the next node hasn&#x27;t been visited before</span></span><br><span class="line">                    <span class="keyword">if</span> (!map.containsKey(next)) &#123;</span><br><span class="line">                        <span class="comment">//Stack the current and the next nodes</span></span><br><span class="line">                        depth++;</span><br><span class="line">                        stack.push(cur);</span><br><span class="line">                        depth++;</span><br><span class="line">                        stack.push(next);</span><br><span class="line">                        <span class="comment">// Assign left value to node on first visit</span></span><br><span class="line">                        <span class="type">NestedSetObj</span> <span class="variable">obj</span> <span class="operator">=</span> NestedSetObj.builder().left(index++).path(next.getAbsolutePath()).depth(depth).build();</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">leaf</span> <span class="operator">=</span> !next.isDirectory();</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">emptyDirLeaf</span> <span class="operator">=</span> next.listFiles() != <span class="literal">null</span> &amp;&amp; next.listFiles().length == <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">//Assign right value to leaf node or empty directory.</span></span><br><span class="line">                        <span class="keyword">if</span> (leaf || emptyDirLeaf) &#123;</span><br><span class="line">                            obj.setRight(index++);</span><br><span class="line">                        &#125;</span><br><span class="line">                        map.put(next, obj);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Determine whether the leaf node&#x27;s right needs to be assigned a value;</span></span><br><span class="line">                <span class="comment">//The current directory can only be assigned a value if all the data in all the child levels have a RIGHT value.                long min = Long.MAX_VALUE;</span></span><br><span class="line">                <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                    <span class="type">NestedSetObj</span> <span class="variable">childObject</span> <span class="operator">=</span> map.get(file);</span><br><span class="line">                    <span class="keyword">if</span> (childObject == <span class="literal">null</span>) &#123;</span><br><span class="line">                        min = <span class="number">0L</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    min = Math.min(min, childObject.getRight());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Assign a value to the right of a non-leaf node.</span></span><br><span class="line">                <span class="comment">// When the first-level child nodes all have a right value, index+1 is the current node&#x27;s right value.                if (min &gt; 0L &amp;&amp; Long.MAX_VALUE != min) &#123;</span></span><br><span class="line">                <span class="keyword">if</span> (min &gt; <span class="number">0L</span> &amp;&amp; Long.MAX_VALUE != min) &#123;</span><br><span class="line">                    <span class="type">NestedSetObj</span> <span class="variable">curObj</span> <span class="operator">=</span> map.get(cur);</span><br><span class="line">                    <span class="keyword">if</span> (curObj.right == <span class="number">0L</span>) &#123;</span><br><span class="line">                        curObj.setRight(index++);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Right value of root = nodes * 2</span></span><br><span class="line">        rootObj.setRight(map.size() * <span class="number">2L</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  Document nested set of objects, business-agnostic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NestedSetObj</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> left;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> right;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> depth;</span><br><span class="line">        <span class="keyword">private</span> String path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then just traverse the data from the <code>NestedSetsUtil#dfs2NestedSets()</code> response, assign it to <code>FileNestedSetsDemo</code>, and batch into the library.</p>
<h3 id="Query-data-based-on-business-requirements"><a href="#Query-data-based-on-business-requirements" class="headerlink" title="Query data based on business requirements"></a>Query data based on business requirements</h3><ul>
<li><p>Retrieve all child nodes of type file under a single path</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> node.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> file_nested_sets_demo <span class="keyword">AS</span> node,</span><br><span class="line">     file_nested_sets_demo <span class="keyword">AS</span> parent</span><br><span class="line"><span class="keyword">WHERE</span>  node.depth <span class="operator">=</span> parent.depth <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> node.left_index  <span class="operator">&gt;</span> parent.left_index</span><br><span class="line">    <span class="keyword">AND</span> node.right_index <span class="operator">&lt;</span> parent.right_index</span><br><span class="line">    <span class="keyword">AND</span> node.tree_id <span class="operator">=</span> <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">AND</span> parent.path <span class="operator">=</span> <span class="string">&#x27;\resources\mapper&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> node.type <span class="operator">=</span> <span class="string">&#x27;FILE&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> parent.left_index</span><br></pre></td></tr></table></figure>
</li>
<li><p>Retrieve all child nodes under a single tree</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> node.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> file_nested_sets_demo <span class="keyword">AS</span> node</span><br><span class="line"><span class="keyword">WHERE</span> node.tree_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> node.left_index</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Extended-Query-Statements"><a href="#Extended-Query-Statements" class="headerlink" title="Extended Query Statements"></a>Extended Query Statements</h3><ul>
<li>Retrieve direct child nodes under a single path</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> node.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> file_nested_sets_demo <span class="keyword">AS</span> node,</span><br><span class="line">     file_nested_sets_demo <span class="keyword">AS</span> parent</span><br><span class="line"><span class="keyword">WHERE</span> node.depth <span class="operator">=</span> parent.depth <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> node.left_index  <span class="operator">&gt;</span> parent.left_index</span><br><span class="line">    <span class="keyword">AND</span> node.right_index <span class="operator">&lt;</span> parent.right_index</span><br><span class="line">    <span class="keyword">AND</span> node.tree_id <span class="operator">=</span> <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">AND</span> parent.path <span class="operator">=</span> <span class="string">&#x27;\resources\mapper&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> parent.left_index</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h1><p>The Java algorithms that can be executed can be found in <a target="_blank" rel="noopener" href="https://github.com/BoboTheKnight/NestedSetDemo">GitHub</a></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SQL-Tree-traversal-Project-Experience-Java-System-Design/">SQL, Tree traversal, Project Experience, Java, System Design</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>Afdian.net</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/" alt="Alipay"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><div class="notification is-danger">You forgot to set the <code>business</code> or <code>currency_code</code> for Paypal. Please set it in <code>_config.yml</code>.</div><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/02/single-node-elasticsearch-and-kibana-installation-instructions/"><span class="level-item">Single Node ElasticSearch and Kibana Installation Instructions</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left  order-1 is-sticky"><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Bobo&#039;s site" height="28"></a><p class="is-size-7"><span>&copy; 2023 BoboTheKnight</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://bobotheknight.github.io/"><i class="/img/favicon.png"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="/js/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>